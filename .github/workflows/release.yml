name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Validate JSON files before release
      run: |
        python -c "
        import json
        import sys
        
        files_to_check = ['ETL.json', 'ETL_EN.json']
        
        for file_path in files_to_check:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                print(f'âœ“ {file_path}: Valid JSON syntax')
            except json.JSONDecodeError as e:
                print(f'âœ— {file_path}: Invalid JSON - {e}')
                sys.exit(1)
            except FileNotFoundError:
                print(f'âœ— {file_path}: File not found')
                sys.exit(1)
        "
    
    - name: Get theory count
      id: get_count
      run: |
        COUNT=$(python -c "
        import json
        with open('ETL.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        print(len(data))
        ")
        echo "THEORY_COUNT=$COUNT" >> $GITHUB_OUTPUT
        
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # Educational Theory Library v${{ steps.get_version.outputs.VERSION }}
        
        ## ðŸ“Š çµ±è¨ˆæƒ…å ±
        - **ç†è«–æ•°**: ${{ steps.get_count.outputs.THEORY_COUNT }} ç†è«–
        - **å¤šè¨€èªžå¯¾å¿œ**: æ—¥æœ¬èªžã€è‹±èªž
        
        ## ðŸ“š å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
        - `ETL.json` - æ—¥æœ¬èªžç‰ˆæ•™è‚²ç†è«–ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        - `ETL_EN.json` - è‹±èªžç‰ˆæ•™è‚²ç†è«–ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        - `examples/` - ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžåˆ¥ã®ä½¿ç”¨ä¾‹
        - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆREADMEã€è²¢çŒ®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ç­‰ï¼‰
        
        ## ðŸ”„ å¤‰æ›´å†…å®¹
        è©³ç´°ãªå¤‰æ›´å†…å®¹ã«ã¤ã„ã¦ã¯ [CHANGELOG.md](CHANGELOG.md) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
        
        ## ðŸ“– ä½¿ç”¨æ–¹æ³•
        1. JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. ãŠå¥½ã¿ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã§èª­ã¿è¾¼ã¿
        3. [examples/](examples/) ãƒ•ã‚©ãƒ«ãƒ€ã®ä¾‹ã‚’å‚è€ƒã«å®Ÿè£…
        
        ## ðŸ¤ è²¢çŒ®
        æ–°ã—ã„ç†è«–ã®è¿½åŠ ã‚„æ”¹å–„ææ¡ˆã¯ [CONTRIBUTING.md](CONTRIBUTING.md) ã‚’ã”è¦§ãã ã•ã„ã€‚
        EOF
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Educational Theory Library v${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        
    - name: Upload ETL.json
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./ETL.json
        asset_name: ETL.json
        asset_content_type: application/json
        
    - name: Upload ETL_EN.json
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./ETL_EN.json
        asset_name: ETL_EN.json
        asset_content_type: application/json
